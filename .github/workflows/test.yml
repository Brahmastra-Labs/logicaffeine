name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    runs-on: ubuntu-latest-m
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install mold linker
        run: sudo apt-get update && sudo apt-get install -y mold

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Build workspace
        run: cargo build --workspace --verbose

      - name: Build LSP binary
        run: cargo build -p logicaffeine-lsp --release

      - name: Run all tests
        run: |
          set -o pipefail
          cargo nextest run --workspace --features logicaffeine-tests/ffi-link-tests --profile ci 2>&1 | tee test_output.txt

      - name: Run web tests
        run: |
          set -o pipefail
          cargo nextest run -p logicaffeine-tests --features web-tests --profile ci 2>&1 | tee -a test_output.txt

      - name: Run doctests
        run: |
          set -o pipefail
          cargo test --workspace --doc 2>&1 | tee -a test_output.txt

      - name: Extract test count
        if: github.ref == 'refs/heads/main'
        id: test_count
        run: |
          NEXTEST=$(grep -oP '\d+ passed' test_output.txt | awk '{s+=$1} END {print s}')
          echo "count=$NEXTEST" >> "$GITHUB_OUTPUT"
          echo "Total tests: $NEXTEST"

      - name: Push badge to badges branch
        if: github.ref == 'refs/heads/main'
        run: |
          echo '{"schemaVersion":1,"label":"tests","message":"${{ steps.test_count.outputs.count }}+","color":"brightgreen"}' > /tmp/badge.json
          cd "$(mktemp -d)"
          git init
          git checkout -b badges
          cp /tmp/badge.json logicaffeine_test_count.json
          git add logicaffeine_test_count.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update test count badge: ${{ steps.test_count.outputs.count }} tests"
          git push --force "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git" badges
